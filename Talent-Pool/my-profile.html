<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - ANKA Hub</title>
  <link rel="stylesheet" href="../Talent-Pool/talent-pool-css.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="../Images/anka-favicon.png">
  <link rel="apple-touch-icon" href="../Images/anka-favicon.png">
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <style>
    /* Profile container & sidebar */
    .profile-container {
      max-width: 1000px;
      margin: 100px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
    }

    .profile-sidebar {
      background: linear-gradient(135deg, #ff8737, #eab033);
      color: white;
      flex: 1 1 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    .profile-sidebar img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #fff;
      margin-bottom: 15px;
    }

    .profile-sidebar h2 { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
    .profile-sidebar p { font-size: 14px; opacity: 0.9; margin-bottom: 15px; }

    .change-password-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .change-password-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    /* Profile details */
    .profile-details { flex: 2 1 600px; padding: 40px; }
    .profile-details h3 {
      font-size: 22px; font-weight: 600; margin-bottom: 20px; color: #fd9e5e;
    }

    .info-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    }

    .info-item {
      background: #f9f9f9; padding: 15px 20px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .info-item label { font-size: 13px; color: #888; display: block; margin-bottom: 5px; }
    .info-item p { font-size: 15px; color: #333; font-weight: 500; }

    /* Right-align button container */
    .button-container {
      display: flex;
      justify-content: flex-end;
      gap: 10px; /* spacing between buttons */
      margin-top: 10px;
    }

    /* Unified modern buttons: same size, right-aligned */
    .button-container button,
    .button-container .logout-btn,
    .button-container a.button-like {
      padding: 12px 22px;
      border-radius: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 160px; /* same width for all buttons */
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
      letter-spacing: 0.2px;
    }

    /* Hover effect for buttons */
    .button-container button:hover,
    .button-container .logout-btn:hover,
    .button-container a.button-like:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.16);
    }

    /* Default Upload/Change CV button colors (change as you like) */
    .button-container button {
      background: linear-gradient(135deg, #fd9e5e, #ffb777);
      color: white;
      border: 1px solid rgba(253, 158, 94, 0.35);
    }
    .button-container button:hover {
      background: linear-gradient(135deg, #ffb777, #fd9e5e);
    }

    /* Logout button special color */
    .button-container .logout-btn {
      background: linear-gradient(135deg, #e74c3c, #ff6b5b);
      color: white;
      border: 1px solid rgba(231, 76, 60, 0.35);
    }
    .button-container .logout-btn:hover {
      background: linear-gradient(135deg, #ff6b5b, #e74c3c);
    }

    /* Uploadcare "Choose a file" link style */
    .uploadcare--widget__button_type_open_text {
      background: none !important;
      border: none !important;
      padding: 0 !important;
      color: #fd9e5e;
      font-weight: 500;
      text-decoration: underline;
      cursor: pointer;
      font-size: 15px;
      margin-right: 10px; /* small spacing before main buttons */
    }

    /* Hide default Uploadcare widget button container (optional) */
    .uploadcare--widget__button_type_open {
      display: inline-block; /* keep the link visible */
    }

    /* Password Change Modal */
    .password-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .password-modal-overlay.active {
      display: flex;
    }

    .password-modal-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .password-modal-card h3 {
      font-size: 22px;
      font-weight: 600;
      color: #fd9e5e;
      margin-bottom: 20px;
      text-align: center;
    }

    .password-modal-card .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .password-modal-card .close-btn:hover {
      background: #f5f5f5;
      color: #333;
    }

    .password-modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .password-modal-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .password-modal-form label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .password-modal-form input {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s ease;
    }

    .password-modal-form input:focus {
      outline: none;
      border-color: #fd9e5e;
    }

    .password-modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .password-modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .password-modal-buttons .submit-btn {
      background: #fd9e5e;
      color: white;
    }

    .password-modal-buttons .submit-btn:hover {
      background: #ffb777;
      transform: translateY(-2px);
    }

    .password-modal-buttons .cancel-btn {
      background: #f5f5f5;
      color: #333;
    }

    .password-modal-buttons .cancel-btn:hover {
      background: #e0e0e0;
    }

    /* Responsive */
    @media(max-width:768px) {
      .info-grid { grid-template-columns: 1fr; }
      .profile-container { flex-direction: column; }
      .button-container { justify-content: center; flex-wrap: wrap; }
      .password-modal-card {
        padding: 25px 20px;
      }
    }
  </style>

</head>
<body>

  <!-- Navbar -->
  <header class="navbar">
    <div class="container nav-container">
      <h1 class="logo"><a href="../loggedIn.html" data-i18n="tp.nav.brand">myANKA</a></h1>
      <input type="checkbox" id="menu-toggle-tp" class="menu-toggle-tp" />
      <label for="menu-toggle-tp" class="hamburger-tp">&#9776;</label>
      <nav class="menu">
        <a href="../Talent-Pool/talent-pool.html" data-i18n="tp.nav.talent">TalentPool</a>
        <a href="../Talent-Pool/job-search.html" data-i18n="tp.nav.jobs">Find Jobs</a>
        <a href="../Talent-Pool/my-profile.html" class="active" data-i18n="tp.nav.profile">My Profile</a>
        <a href="../Talent-Pool/faq.html" data-i18n="tp.nav.faq">FAQ</a>
      </nav>
      <div class="nav-right">
        <div class="auth-links">
          <a href="#" class="login-link" id="welcomeMessage"></a>
        </div>
        <div class="lang-toggle" aria-label="Language selector">
          <button type="button" class="lang-btn" data-lang="en">ENG</button>
          <span class="lang-sep">|</span>
          <button type="button" class="lang-btn" data-lang="tr">TR</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Profile Content -->
  <section class="profile-container">
    <div class="profile-sidebar">
      <img id="profilePhoto" src="../Images/talentpool-pp.avif" alt="User Photo">
      <h2 id="userFullName">User Name</h2>
      <p id="userUsername">@username</p>
      <button class="change-password-btn" id="editProfileBtn" data-i18n="tp.profile.edit_profile">Edit Profile</button>
    </div>

    <div class="profile-details">
      <h3 data-i18n="tp.profile.title">Personal Information</h3>
      <div class="info-grid">
        <div class="info-item">
          <label data-i18n="tp.profile.labels.university">University</label>
          <p id="userUni">-</p>
        </div>
        <div class="info-item">
          <label data-i18n="tp.profile.labels.major">Major</label>
          <p id="userMajor">-</p>
        </div>
        <div class="info-item">
          <label data-i18n="tp.profile.labels.gender">Gender</label>
          <p id="userGender">-</p>
        </div>
        <div class="info-item">
          <label data-i18n="tp.profile.labels.yob">Year of Birth</label>
          <p id="userYob">-</p>
        </div>
      </div>

      <!-- CV -->
      <div class="info-item" style="margin-top:15px;">
        <label data-i18n="tp.profile.labels.cv">Current CV</label>
        <p id="userCV"><span data-i18n="tp.profile.cv_empty">No CV uploaded</span></p>
      </div>

      <!-- Uploadcare -->
      <div class="button-container">
        <input
        type="hidden"
        role="uploadcare-uploader"
        data-public-key="3cfb4e60399cef8a900f"
        data-multiple="false"
        data-images-only="false"
        data-accept="application/pdf"
        />
        <button id="uploadCVBtn" data-i18n="tp.profile.upload_cv">Upload CV</button>
        <button id="changeCVBtn" style="display:none;" data-i18n="tp.profile.change_cv">Change CV</button>
        <a href="../login.html" class="logout-btn" id="logoutBtn" data-i18n="tp.profile.logout">Logout</a>
      </div>
    </div>
  </section>

  <!-- Edit Profile Modal -->
  <div class="password-modal-overlay" id="editProfileModal">
    <div class="password-modal-card" style="max-width: 550px;">
      <button class="close-btn" id="closeEditProfileModal">&times;</button>
      <h3 data-i18n="tp.profile.edit_profile">Edit Profile</h3>
      <form class="password-modal-form" id="editProfileForm" novalidate>
        <div class="form-group">
          <label for="editName" data-i18n="tp.profile.labels.name">Name</label>
          <input type="text" id="editName" name="name">
        </div>
        <div class="form-group">
          <label for="editSurname" data-i18n="tp.profile.labels.surname">Surname</label>
          <input type="text" id="editSurname" name="surname">
        </div>
        <div class="form-group">
          <label for="editUni" data-i18n="tp.profile.labels.university">University</label>
          <input type="text" id="editUni" name="uni">
        </div>
        <div class="form-group">
          <label for="editMajor" data-i18n="tp.profile.labels.major">Major</label>
          <input type="text" id="editMajor" name="major">
        </div>
        <div class="form-group">
          <label for="editYob" data-i18n="tp.profile.labels.yob">Year of Birth</label>
          <input type="text" id="editYob" name="yob" placeholder="e.g., 2000">
        </div>
        <div class="form-group">
          <label for="editPassword" data-i18n="tp.profile.password.new">New Password (leave empty to keep current)</label>
          <input type="password" id="editPassword" name="password" placeholder="Leave empty to keep current password">
        </div>
        <div class="password-modal-buttons">
          <button type="button" class="cancel-btn" id="cancelEditProfileBtn" data-i18n="tp.profile.password.cancel">Cancel</button>
          <button type="submit" class="submit-btn" data-i18n="tp.profile.edit_profile.save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer"></div>

<script src="../i18n.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const t = (key, fallback) =>
      (window.getI18nString ? window.getI18nString(key) : '') || fallback;

    const welcomeElement = document.getElementById("welcomeMessage");
    const fullNameEl = document.getElementById("userFullName");
    const usernameEl = document.getElementById("userUsername");
    const uniEl = document.getElementById("userUni");
    const majorEl = document.getElementById("userMajor");
    const genderEl = document.getElementById("userGender");
    const yobEl = document.getElementById("userYob");
    const logoutBtn = document.getElementById("logoutBtn");
    const cvEl = document.getElementById("userCV");
    const uploadCVBtn = document.getElementById("uploadCVBtn");
    const changeCVBtn = document.getElementById("changeCVBtn");
    const editProfileBtn = document.getElementById("editProfileBtn");
    const editProfileModal = document.getElementById("editProfileModal");
    const closeEditProfileModal = document.getElementById("closeEditProfileModal");
    const cancelEditProfileBtn = document.getElementById("cancelEditProfileBtn");
    const editProfileForm = document.getElementById("editProfileForm");
    let currentUserData = null;

     // Load footer
     fetch('../Partials/footer-loggedin.html')
       .then(res => res.text())
       .then(data => {
         document.getElementById('footer').innerHTML = data;
         const yearEl = document.getElementById('year');
         if (yearEl) yearEl.textContent = new Date().getFullYear();
         // Fix paths for Talent Pool pages (footer-loggedin.html uses root-relative paths)
         const footerLinks = document.querySelectorAll('#footer a[href]');
         footerLinks.forEach(link => {
           const href = link.getAttribute('href');
           if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('../')) {
             // Handle Talent-Pool/ paths specially
             if (href.startsWith('Talent-Pool/')) {
               link.setAttribute('href', href.replace('Talent-Pool/', ''));
             } else {
               link.setAttribute('href', '../' + href);
             }
           }
         });
         // Fix image paths
         const footerImages = document.querySelectorAll('#footer img[src]');
         footerImages.forEach(img => {
           const src = img.getAttribute('src');
           if (src && !src.startsWith('http') && !src.startsWith('../') && !src.startsWith('data:')) {
             img.setAttribute('src', '../' + src);
           }
         });
       })
       .catch(() => {
         // Fallback to regular footer if logged-in footer doesn't exist
         fetch('../Partials/footer.html')
           .then(res => res.text())
           .then(data => {
             document.getElementById('footer').innerHTML = data;
             const yearEl = document.getElementById('year');
             if (yearEl) yearEl.textContent = new Date().getFullYear();
             // Fix tüzük link path for Talent Pool pages
             const tuzukLink = document.querySelector('#footer a[href*="tuzuk"]');
             if (tuzukLink && tuzukLink.getAttribute('href') === 'docs/tuzuk2025.pdf') {
               tuzukLink.setAttribute('href', '../docs/tuzuk2025.pdf');
             }
           });
       });

    // Session check
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    const username = sessionStorage.getItem('username');
    const storedName = sessionStorage.getItem('name');

    if (isLoggedIn !== 'true' || !username) {
      window.location.href = '../login.html';
      return;
    }

    if (storedName) {
      const template = t('tp.welcome', 'Welcome {name}!');
      welcomeElement.textContent = template.replace('{name}', storedName);
    } else {
      welcomeElement.textContent = t('tp.welcome_member', 'Welcome member!');
    }

    // Fetch user data
    fetch(`https://anka-vkrl.onrender.com/api/users?username=${encodeURIComponent(username)}`)
      .then(res => { if (!res.ok) throw new Error("User fetch failed"); return res.json(); })
      .then(user => {
        currentUserData = user; // Store for edit modal
        fullNameEl.textContent = `${user.name || ''} ${user.surname || ''}`;
        usernameEl.textContent = '@' + user.username;
        uniEl.textContent = user.uni || '-';
        majorEl.textContent = user.major || '-';
        genderEl.textContent = user.gender || '-';
        yobEl.textContent = user.yob || '-';

        if (user.cvLink) {
          cvEl.innerHTML = `<a href="${user.cvLink}" target="_blank" data-i18n="tp.profile.view_cv">${t('tp.profile.view_cv', 'View CV')}</a>`;
          uploadCVBtn.style.display = "none";
          changeCVBtn.style.display = "inline-block";
        }
      })
      .catch(err => { 
        console.error("User fetch error:", err); 
        fullNameEl.textContent = t('tp.profile.error', 'Error loading profile');
      });

    // Logout
    logoutBtn.addEventListener("click", () => {
      sessionStorage.clear();
      window.location.href = "../login.html";
    });

    // Initialize Uploadcare widget
    const widget = uploadcare.Widget('[role=uploadcare-uploader]');

    async function uploadCV() {
      const file = widget.value();
      if (!file) {
        alert(t('tp.profile.upload_select', 'Please select a PDF file first.'));
        return;
      }

      uploadCVBtn.disabled = true;
      uploadCVBtn.textContent = t('tp.profile.uploading', 'Uploading...');

      try {
        const fileInfo = await file.promise();
        const cvURL = fileInfo.cdnUrl;

        // Save CV URL to backend (MongoDB)
        const res = await fetch("https://anka-vkrl.onrender.com/api/users/update-cv", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, cvLink: cvURL })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "Failed to save CV in database");
        }

        // Update UI
        cvEl.innerHTML = `<a href="${cvURL}" target="_blank" data-i18n="tp.profile.view_cv">${t('tp.profile.view_cv', 'View CV')}</a>`;
        uploadCVBtn.style.display = "none";
        changeCVBtn.style.display = "inline-block";

        alert(t('tp.profile.upload_success', 'CV uploaded and saved successfully!'));
      } catch (err) {
        console.error("CV upload/save error:", err);
        alert(t('tp.profile.upload_fail', 'Upload failed! Please try again.'));
      } finally {
        uploadCVBtn.disabled = false;
        uploadCVBtn.textContent = t('tp.profile.upload_cv', 'Upload CV');
      }
    }

    uploadCVBtn.addEventListener("click", uploadCV);
    changeCVBtn.addEventListener("click", uploadCV);

    // Edit Profile Modal
    function openEditProfileModal() {
      if (currentUserData) {
        document.getElementById("editName").value = currentUserData.name || '';
        document.getElementById("editSurname").value = currentUserData.surname || '';
        document.getElementById("editUni").value = currentUserData.uni || '';
        document.getElementById("editMajor").value = currentUserData.major || '';
        document.getElementById("editYob").value = currentUserData.yob || '';
        document.getElementById("editPassword").value = '';
      }
      editProfileModal.classList.add("active");
    }

    function closeEditProfileModalFunc() {
      editProfileModal.classList.remove("active");
      editProfileForm.reset();
    }

    editProfileBtn.addEventListener("click", openEditProfileModal);
    closeEditProfileModal.addEventListener("click", closeEditProfileModalFunc);
    cancelEditProfileBtn.addEventListener("click", closeEditProfileModalFunc);

    // Close modal when clicking outside
    editProfileModal.addEventListener("click", (e) => {
      if (e.target === editProfileModal) {
        closeEditProfileModalFunc();
      }
    });

    // Handle form submission
    editProfileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      e.stopPropagation(); // Prevent any validation
      
      const submitBtn = editProfileForm.querySelector(".submit-btn");
      const originalBtnText = submitBtn.textContent;
      
      const name = document.getElementById("editName").value.trim();
      const surname = document.getElementById("editSurname").value.trim();
      const uni = document.getElementById("editUni").value.trim();
      const major = document.getElementById("editMajor").value.trim();
      const yob = document.getElementById("editYob").value.trim();
      const password = document.getElementById("editPassword").value.trim();

      // Basic validation
      if (!name || !surname) {
        alert(t('tp.profile.name_required', 'Name and Surname are required'));
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
        return;
      }
      
      // Validate yob if provided (should be 4 digits or empty)
      if (yob && yob.length > 0 && !/^\d{4}$/.test(yob)) {
        alert(t('tp.profile.yob_invalid', 'Year of Birth must be a 4-digit number (e.g., 2000) or leave empty'));
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
        return;
      }

      // Disable button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = t('tp.profile.saving', 'Saving...');

      try {
        // Prepare update data
        const updateData = {
          username: username,
          name: name,
          surname: surname
        };
        
        if (uni && uni.length > 0) updateData.uni = uni;
        if (major && major.length > 0) updateData.major = major;
        if (yob && yob.length > 0) updateData.yob = yob;
        if (password && password.length > 0) updateData.password = password;

        const response = await fetch("https://anka-vkrl.onrender.com/api/users/update-profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updateData)
        });

        let data;
        try {
          const text = await response.text();
          data = text ? JSON.parse(text) : {};
        } catch (parseErr) {
          console.error("Response parse error:", parseErr);
          throw new Error("Server response error. Please check if backend is deployed.");
        }

        if (!response.ok) {
          throw new Error(data.message || `Failed to update profile (${response.status})`);
        }

        // Success - reload user data
        alert(t('tp.profile.update_success', 'Profile updated successfully!'));
        closeEditProfileModalFunc();
        
        // Reload page to show updated data
        window.location.reload();
      } catch (err) {
        console.error("Profile update error:", err);
        alert(err.message || t('tp.profile.update_error', 'Failed to update profile. Please try again.'));
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });
  });
</script>

