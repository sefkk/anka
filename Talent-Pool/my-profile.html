<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - ANKA Hub</title>
  <link rel="stylesheet" href="../Talent-Pool/talent-pool-css.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <style>
    /* Same CSS as before */
    .profile-container {
      max-width: 1000px;
      margin: 100px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
    }
    .profile-sidebar {
      background: linear-gradient(135deg, #ff8737, #eab033);
      color: white;
      flex: 1 1 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }
    .profile-sidebar img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #fff;
      margin-bottom: 15px;
    }
    .profile-sidebar h2 { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
    .profile-sidebar p { font-size: 14px; opacity: 0.9; margin-bottom: 25px; }
    .edit-btn {
      background: #fff; color: #fd9e5e; padding: 10px 22px;
      border-radius: 12px; text-decoration: none; font-weight: 600;
      transition: all 0.3s ease;
    }
    .edit-btn:hover { background: #f1f1f1; transform: translateY(-2px); }
    .profile-details { flex: 2 1 600px; padding: 40px; }
    .profile-details h3 {
      font-size: 22px; font-weight: 600; margin-bottom: 20px; color: #fd9e5e;
    }
    .info-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    }
    .info-item {
      background: #f9f9f9; padding: 15px 20px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .info-item label { font-size: 13px; color: #888; display: block; margin-bottom: 5px; }
    .info-item p { font-size: 15px; color: #333; font-weight: 500; }
    .logout-btn {
      background: #e74c3c; color: white; padding: 10px 20px;
      border-radius: 12px; font-weight: 600; text-decoration: none;
      display: inline-block; margin-top: 30px; transition: all 0.3s ease;
    }
    .logout-btn:hover { background: #c0392b; }
    @media(max-width:768px) {
      .info-grid { grid-template-columns: 1fr; }
      .profile-container { flex-direction: column; }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <header class="navbar">
    <div class="container nav-container">
      <h1 class="logo"><a href="../loggedIn.html">myANKA</a></h1>
      <nav class="menu">
        <a href="../Talent-Pool/talent-pool.html">Home</a>
        <a href="job-search.html">Find Jobs</a>
        <a href="my-profile.html" class="active">My Profile</a>
        <a href="../Talent-Pool/faq.html">FAQ</a>
      </nav>
      <div class="auth-links">
        <a href="#" class="login-link" id="welcomeMessage"></a>
      </div>
    </div>
  </header>

  <!-- Profile Content -->
  <section class="profile-container">
    <div class="profile-sidebar">
      <img id="profilePhoto" src="../Images/talentpool-pp.avif" alt="User Photo">
      <h2 id="userFullName">User Name</h2>
      <p id="userUsername">@username</p>
      <a href="#" class="edit-btn">Edit Profile</a>
    </div>

    <div class="profile-details">
      <h3>Personal Information</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>University</label>
          <p id="userUni">-</p>
        </div>
        <div class="info-item">
          <label>Major</label>
          <p id="userMajor">-</p>
        </div>
        <div class="info-item">
          <label>Gender</label>
          <p id="userGender">-</p>
        </div>
        <div class="info-item">
          <label>Year of Birth</label>
          <p id="userYob">-</p>
        </div>
      </div>

      <!-- CV -->
      <div class="info-item" style="margin-top:15px;">
        <label>Current CV</label>
        <p id="userCV">No CV uploaded</p>
      </div>

      <!-- Uploadcare -->
      <input
        type="hidden"
        role="uploadcare-uploader"
        data-public-key="3cfb4e60399cef8a900f"
        data-multiple="false"
        data-images-only="false"
        data-accept="application/pdf"
      />
      <button id="uploadCVBtn" class="edit-btn">Upload CV</button>
      <button id="changeCVBtn" class="edit-btn" style="display:none;">Change CV</button>

      <a href="../login.html" class="logout-btn" id="logoutBtn">Logout</a>
    </div>
  </section>

  <!-- Footer -->
  <div id="footer"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const welcomeElement = document.getElementById("welcomeMessage");
  const fullNameEl = document.getElementById("userFullName");
  const usernameEl = document.getElementById("userUsername");
  const uniEl = document.getElementById("userUni");
  const majorEl = document.getElementById("userMajor");
  const genderEl = document.getElementById("userGender");
  const yobEl = document.getElementById("userYob");
  const logoutBtn = document.getElementById("logoutBtn");
  const cvEl = document.getElementById("userCV");
  const uploadCVBtn = document.getElementById("uploadCVBtn");
  const changeCVBtn = document.getElementById("changeCVBtn");

  // Load footer
  fetch('../Partials/footer.html')
    .then(res => res.text())
    .then(data => { document.getElementById('footer').innerHTML = data; });

  // Session check
  const isLoggedIn = sessionStorage.getItem('isLoggedIn');
  const username = sessionStorage.getItem('username');
  const storedName = sessionStorage.getItem('name');

  if (isLoggedIn !== 'true' || !username) {
    window.location.href = '../login.html';
    return;
  }

  if (storedName) welcomeElement.textContent = `Welcome ${storedName}!`;

  // Fetch user data
  fetch(`https://anka-vkrl.onrender.com/api/users?username=${encodeURIComponent(username)}`)
    .then(res => { if (!res.ok) throw new Error("User fetch failed"); return res.json(); })
    .then(user => {
      fullNameEl.textContent = `${user.name || ''} ${user.surname || ''}`;
      usernameEl.textContent = '@' + user.username;
      uniEl.textContent = user.uni || '-';
      majorEl.textContent = user.major || '-';
      genderEl.textContent = user.gender || '-';
      yobEl.textContent = user.yob || '-';

      if (user.cvLink) {
        cvEl.innerHTML = `<a href="${user.cvLink}" target="_blank">View CV</a>`;
        uploadCVBtn.style.display = "none";
        changeCVBtn.style.display = "inline-block";
      }
    })
    .catch(err => { console.error("User fetch error:", err); fullNameEl.textContent = "Error loading profile"; });

  // Logout
  logoutBtn.addEventListener("click", () => {
    sessionStorage.clear();
    window.location.href = "../login.html";
  });

  // Uploadcare widget
  const widget = uploadcare.Widget('[role=uploadcare-uploader]');

  async function uploadCV() {
    const file = await widget.value();
    if (!file) { alert("Please select a PDF file first."); return; }

    uploadCVBtn.disabled = true;
    uploadCVBtn.textContent = "Uploading...";

    try {
      const fileInfo = await file.promise();
      const cvURL = fileInfo.cdnUrl;

      // Save CV link to backend
      fetch("https://anka-vkrl.onrender.com/api/users/update-cv", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, cvLink: cvURL })
      })
      .then(async res => {
        const text = await res.text();
        if (!res.ok) { alert("CV update failed: " + text); return; }
        location.reload();
      })
      .catch(err => console.error("CV update error:", err));

    } catch (err) {
      console.error(err);
      alert("Upload failed!");
    } finally {
      uploadCVBtn.disabled = false;
      uploadCVBtn.textContent = "Upload CV";
    }
  }

  uploadCVBtn.addEventListener("click", uploadCV);
  changeCVBtn.addEventListener("click", uploadCV);
});
</script>

</body>
</html>
