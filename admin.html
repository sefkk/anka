<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
<link rel="stylesheet" href="style.css"/>
<title>ANKA Admin Panel</title>

<style>
:root{
  --bg:#f5f7fa; --text:#1a202c; --muted:#718096;
  --brand-1:#f0b26f; --brand-2:#e2874a; --ring:#ffcf9b;
  --radius:16px; 
  --shadow:0 2px 8px rgba(0,0,0,.04), 0 1px 3px rgba(0,0,0,.08);
  --shadow-md:0 4px 12px rgba(0,0,0,.08), 0 2px 4px rgba(0,0,0,.06);
  --shadow-lg:0 12px 32px rgba(0,0,0,.12), 0 4px 8px rgba(0,0,0,.08);
  --danger:#ef4444; --success:#10b981;
  --border:#e2e8f0; --card-bg:#ffffff;
  --hover-bg:#f8fafc;
}

*{ box-sizing:border-box; scroll-behavior: smooth; }

body{
  margin:0; padding:0; font-family:'Poppins',system-ui,-apple-system,sans-serif; 
  color:var(--text); background: linear-gradient(135deg, #f5f7fa 0%, #e8edf3 100%);
  line-height:1.6; min-height:100vh;
}

.container{width:min(100% - 2rem, 1400px); margin-inline:auto; padding:0 1.5rem;}

/* Admin Header */
.admin-header{
  background: linear-gradient(135deg, #f0b26f 0%, #e2874a 50%, #d97744 100%);
  color:#fff; padding:3rem 0; margin-bottom:3rem;
  box-shadow: var(--shadow-lg);
  position:relative; overflow:hidden;
}

.admin-header::before{
  content:''; position:absolute; top:0; left:0; right:0; bottom:0;
  background:url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
  opacity:.3;
}

.admin-header .container{
  position:relative; z-index:1;
}

.admin-header h1{
  margin:0; font-size:2.75rem; font-weight:700; 
  display:flex; align-items:center; gap:1rem;
  text-shadow:0 2px 8px rgba(0,0,0,.1);
  letter-spacing:-0.5px;
}

.admin-header h1 i{
  font-size:2.5rem; opacity:.95;
  background:rgba(255,255,255,.15); padding:.75rem; border-radius:12px;
  backdrop-filter:blur(10px);
}

.admin-header p{
  margin:1rem 0 0; opacity:.95; font-size:1.15rem;
  font-weight:400; letter-spacing:0.2px;
}

.back-to-myanka{
  display:inline-flex; align-items:center; gap:.75rem;
  color:#fff; text-decoration:none; font-weight:600;
  font-size:.95rem; margin-bottom:1.5rem;
  padding:.75rem 1.5rem; background:rgba(255,255,255,.15);
  border-radius:10px; backdrop-filter:blur(10px);
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  border:2px solid rgba(255,255,255,.2);
}

.back-to-myanka:hover{
  background:rgba(255,255,255,.25);
  transform:translateX(-4px);
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  color: #1a202c;
}

.back-to-myanka i{
  font-size:1rem;
}

/* Tabs */
.admin-tabs{
  display:flex; gap:.75rem; margin-bottom:2.5rem; 
  background:var(--card-bg); padding:1rem;
  border-radius:var(--radius); box-shadow: var(--shadow-md);
  border:1px solid var(--border);
  overflow-x:auto;
}

.tab-btn{
  padding:1rem 2rem; border:none; background:transparent;
  font-size:1rem; font-weight:600; color:var(--muted);
  cursor:pointer; border-radius:10px;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative; display:flex; align-items:center; gap:.75rem;
  white-space:nowrap;
  border:2px solid transparent;
}

.tab-btn:hover{ 
  color:var(--brand-2); 
  background:linear-gradient(135deg, rgba(240,178,111,.08) 0%, rgba(226,135,74,.08) 100%);
  transform:translateY(-2px);
}

.tab-btn.active{
  color:var(--brand-2); 
  background:linear-gradient(135deg, rgba(240,178,111,.15) 0%, rgba(226,135,74,.15) 100%);
  border-color:var(--brand-2);
  box-shadow:0 4px 12px rgba(226,135,74,.2);
}

.tab-btn.active::before{
  content:''; position:absolute; bottom:-1rem; left:50%; transform:translateX(-50%);
  width:40px; height:3px; background:var(--brand-2);
  border-radius:2px;
}

.tab-btn i{
  font-size:1.15rem;
}

/* Tab Content */
.tab-content{ 
  display:none; 
  animation:fadeIn .3s ease;
}

.tab-content.active{ display:block; }

@keyframes fadeIn{
  from{ opacity:0; transform:translateY(10px); }
  to{ opacity:1; transform:translateY(0); }
}

/* Forms */
.admin-form{
  background:var(--card-bg); padding:2.5rem; border-radius:var(--radius);
  box-shadow: var(--shadow-md); margin-bottom:2.5rem;
  border:1px solid var(--border);
  transition:all .3s ease;
}

.admin-form:hover{
  box-shadow: var(--shadow-lg);
  transform:translateY(-2px);
}

.admin-form h2{
  margin:0 0 2rem; font-size:1.875rem; color:var(--text);
  padding-bottom:1.25rem; border-bottom:3px solid var(--border);
  font-weight:700; letter-spacing:-0.3px;
  display:flex; align-items:center; gap:.75rem;
}

.admin-form h2::before{
  content:''; width:4px; height:24px; 
  background:linear-gradient(135deg, var(--brand-1), var(--brand-2));
  border-radius:2px;
}

.form-group{
  margin-bottom:1.75rem;
}

.form-group label{
  display:block; margin-bottom:.75rem; font-weight:600; color:var(--text);
  font-size:.95rem;
}

.form-group input,
.form-group textarea,
.form-group select{
  width:100%; padding:1rem 1.25rem; border:2px solid var(--border);
  border-radius:12px; font-size:1rem; font-family:inherit;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1); 
  background:var(--card-bg);
  color:var(--text);
}

.form-group select{
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 1.25rem center;
  background-size:1.25rem;
  padding-right:3.5rem;
  cursor:pointer;
  position:relative;
}

.form-group select:hover{
  border-color:var(--brand-1);
  background-color:#fff;
  box-shadow:0 2px 8px rgba(226,135,74,.08);
}

.form-group select:focus{
  outline:none; border-color:var(--brand-2);
  box-shadow:0 0 0 4px rgba(226,135,74,.12), var(--shadow-md);
  transform:translateY(-1px);
  background-color:#fff;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23e2874a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
}

.form-group select option{
  padding:1rem;
  background:#fff;
  color:var(--text);
  font-size:1rem;
}

.form-group select option:hover,
.form-group select option:focus,
.form-group select option:checked{
  background:linear-gradient(135deg, rgba(240,178,111,.1) 0%, rgba(226,135,74,.1) 100%);
  color:var(--brand-2);
  font-weight:600;
}

.form-group input:focus,
.form-group textarea:focus{
  outline:none; border-color:var(--brand-2);
  box-shadow:0 0 0 4px rgba(226,135,74,.12), var(--shadow-md);
  transform:translateY(-1px);
  background:#fff;
}

.form-group textarea{
  min-height:140px; resize:vertical; line-height:1.6;
}

.form-row{
  display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;
}

@media (max-width:768px){
  .form-row{ grid-template-columns:1fr; }
  .admin-form{ padding:1.5rem; }
  .admin-tabs{ flex-wrap:wrap; padding:.25rem; }
  .tab-btn{ padding:.75rem 1.25rem; font-size:.9rem; }
}

#talent-pool{
  background-color: #f5f7fa;
}

#startups{
  background-color: #f5f7fa;
}

#news{
  background-color: #f5f7fa;
}

#legacy {
  background-color: #f5f7fa;
}

#users{
  background-color: #f5f7fa;
}

#logs{
  background-color: #f5f7fa;
}

#admin-access{
  background-color: #f5f7fa;
}

#admin-access .admin-form,
#admin-access .items-list{
  box-shadow: none;
}

.permission-toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.35rem 0.7rem;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: #fff;
  box-shadow: var(--shadow);
  font-size: 0.85rem;
  color: var(--text);
}

.permission-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--brand-2);
}

.permission-toggle input[type="checkbox"]:disabled {
  accent-color: #cbd5e1;
}

.permission-toggle.disabled {
  opacity: 0.6;
}

.form-group small{
  display:block; margin-top:.25rem; color:var(--muted);
  font-size:.85rem;
}

.form-group input[readonly]{
  background:#f8f9fa; cursor:not-allowed;
  opacity:.8;
  transition: color 0.3s ease;
}

.form-group input[readonly].username-available{
  color:#22c55e !important;
}

.form-group input[readonly].username-taken{
  color:#f59e0b !important;
}

.btn{
  padding:1rem 2.25rem; border:none; border-radius:12px;
  font-size:1rem; font-weight:600; cursor:pointer;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1); 
  display:inline-flex; align-items:center;
  gap:.75rem; box-shadow: var(--shadow-md);
  position:relative; overflow:hidden;
}

.btn::before{
  content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent);
  transition:left .5s ease;
}

.btn:hover::before{
  left:100%;
}

.btn-primary{
  background: linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
  color:#fff; border:2px solid transparent;
}

.btn-primary:hover{
  transform:translateY(-3px); 
  box-shadow:0 8px 24px rgba(226,135,74,.4), 0 4px 8px rgba(226,135,74,.2);
}

.btn-primary:active{
  transform:translateY(-1px);
}

.btn-danger{
  background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color:#fff; border:2px solid transparent;
}

.btn-danger:hover{
  background:linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  transform:translateY(-3px);
  box-shadow:0 8px 24px rgba(239,68,68,.4), 0 4px 8px rgba(239,68,68,.2);
}

.btn-small{
  padding:.5rem 1rem; font-size:.875rem;
}

/* Lists */
.items-list{
  background:var(--card-bg); border-radius:var(--radius);
  box-shadow: var(--shadow-md); overflow:hidden;
  border:1px solid var(--border);
}

.items-list h2{
  margin:0; padding:2rem; 
  background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-bottom:2px solid var(--border); font-size:1.625rem;
  color:var(--text); font-weight:700;
  display:flex; align-items:center; gap:.75rem;
}

.item-card{
  padding:2rem; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:start;
  gap:2rem; transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
}

.item-card::before{
  content:''; position:absolute; left:0; top:0; bottom:0; width:4px;
  background:transparent; transition:all .3s ease;
}

.item-card:hover{
  background:var(--hover-bg);
  transform:translateX(4px);
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}

.item-card:hover::before{
  background:linear-gradient(135deg, var(--brand-1), var(--brand-2));
}

.item-card:last-child{ border-bottom:none; }

.item-info{ flex:1; }
.item-info h3{
  margin:0 0 .75rem; font-size:1.35rem; color:var(--text);
  font-weight:600;
}
.item-info p{
  margin:.5rem 0; color:var(--muted); font-size:.95rem;
  line-height:1.6;
}

.item-info p strong{
  color:var(--text); font-weight:600;
}

.item-actions{
  display:flex; gap:.75rem; flex-wrap:wrap; align-items:flex-start;
}

.applicants-btn{
  background:var(--brand-1); color:#fff;
  box-shadow: var(--shadow);
}

.applicants-btn:hover{
  background:var(--brand-2); transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(240,178,111,.4);
}

/* Modal */
.modal{
  display:none; position:fixed; inset:0; z-index:1000;
  background:rgba(0,0,0,.6); backdrop-filter:blur(6px);
  align-items:center; justify-content:center; padding:1rem;
  animation:fadeIn .2s ease;
}

.modal.active{ display:flex; }

.modal-content{
  background:var(--card-bg); border-radius:var(--radius); padding:2.5rem;
  max-width:750px; width:100%; max-height:85vh; overflow-y:auto;
  box-shadow:0 32px 64px rgba(0,0,0,.3), 0 8px 16px rgba(0,0,0,.2);
  animation:slideUp .4s cubic-bezier(0.4, 0, 0.2, 1);
  border:1px solid var(--border);
  position:relative;
}

.modal-content::before{
  content:''; position:absolute; top:0; left:0; right:0; height:4px;
  background:linear-gradient(90deg, var(--brand-1), var(--brand-2));
  border-radius:var(--radius) var(--radius) 0 0;
}

@keyframes slideUp{
  from{ transform:translateY(20px); opacity:0; }
  to{ transform:translateY(0); opacity:1; }
}

.modal-header{
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:2rem; padding-bottom:1rem; border-bottom:2px solid var(--border);
}

.modal-header h2{
  margin:0; font-size:1.75rem; color:var(--text);
}

.modal-close{
  background:none; border:none; font-size:2rem;
  cursor:pointer; color:var(--muted); line-height:1;
  width:36px; height:36px; display:flex; align-items:center;
  justify-content:center; border-radius:50%; transition:all .2s ease;
}

.modal-close:hover{ 
  color:var(--text); background:#f8f9fa;
}

.applicants-list{
  list-style:none; padding:0; margin:0;
}

.applicant-item{
  padding:1.5rem; background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius:12px; margin-bottom:1rem; 
  border:2px solid var(--border);
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  overflow:hidden;
}

.applicant-item::before{
  content:''; position:absolute; left:0; top:0; bottom:0; width:4px;
  background:transparent; transition:all .3s ease;
}

.applicant-item:hover{
  background:var(--card-bg); box-shadow: var(--shadow-md);
  transform:translateX(6px) translateY(-2px);
  border-color:var(--brand-2);
}

.applicant-item:hover::before{
  background:linear-gradient(135deg, var(--brand-1), var(--brand-2));
}

.applicant-item strong{
  display:block; margin-bottom:.5rem; color:var(--text);
  font-size:1.1rem;
}

.applicant-item p{
  margin:.25rem 0; color:var(--muted); font-size:.9rem;
}

.applicant-item a{
  color:var(--brand-2); text-decoration:none; font-weight:500;
  transition:color .2s ease;
}

.applicant-item a:hover{ 
  color:var(--brand-1); text-decoration:underline;
}

.empty-state{
  text-align:center; padding:4rem 2rem; color:var(--muted);
}

.empty-state i{
  font-size:4rem; margin-bottom:1.5rem; opacity:.3;
  color:var(--muted);
}

.empty-state p{
  font-size:1.1rem; margin:0;
}

.alert{
  padding:1.25rem 1.75rem; border-radius:12px; margin-bottom:1.5rem;
  display:flex; align-items:center; gap:1rem; font-weight:500;
  box-shadow: var(--shadow-md);
  border-left:4px solid;
  animation:slideIn .3s ease;
}

@keyframes slideIn{
  from{ transform:translateX(-20px); opacity:0; }
  to{ transform:translateX(0); opacity:1; }
}

.alert-success{
  background:#d4edda; color:#155724; border:1px solid #c3e6cb;
}

.alert-error{
  background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;
}

.alert i{
  font-size:1.25rem;
}

#alertContainer{
  position:sticky; top:1rem; z-index:100; margin-bottom:1rem;
}

.admin-checkbox-label {
  position: relative;
  display: inline-block;
  cursor: not-allowed;
}

.admin-checkbox-label .admin-checkbox-tooltip {
  position: absolute;
  bottom: 100%;
  left: 0;
  margin-bottom: 5px;
  padding: 5px 10px;
  background: #333;
  color: #fff;
  border-radius: 4px;
  font-size: 0.75rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  z-index: 1000;
}

.admin-checkbox-label:hover .admin-checkbox-tooltip {
  opacity: 1;
}
</style>
</head>
<body>

<div class="admin-header">
  <div class="container">
    <a href="loggedIn.html" class="back-to-myanka">
      <i class="fas fa-arrow-left"></i> MyANKA'ya Geri Dön
    </a>
    <h1><i class="fas fa-shield-alt"></i> ANKA Admin Panel</h1>
    <p>Manage Talent Pool, Startup Hub, and News</p>
  </div>
</div>

<div class="container">
  <div id="alertContainer"></div>

  <div class="admin-tabs">
    <button class="tab-btn active" data-tab="talent-pool">
      <i class="fas fa-briefcase"></i> Talent Pool
    </button>
    <button class="tab-btn" data-tab="startups">
      <i class="fas fa-rocket"></i> Startup Hub
    </button>
    <button class="tab-btn" data-tab="news">
      <i class="fas fa-newspaper"></i> News
    </button>
    <button class="tab-btn" data-tab="legacy">
      <i class="fas fa-history"></i> Legacy
    </button>
    <button class="tab-btn" data-tab="users">
      <i class="fas fa-user-plus"></i> Add Member
    </button>
  </div>

  <!-- Talent Pool Tab -->
  <div id="talent-pool" class="tab-content active">
    <div class="admin-form">
      <h2>Add New Job Posting</h2>
      <form id="addJobForm">
        <div class="form-row">
          <div class="form-group">
            <label>Company Name *</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>Industry *</label>
            <input type="text" name="industry" required>
          </div>
        </div>
        <div class="form-group">
          <label>Short Description *</label>
          <textarea name="description_short" required></textarea>
        </div>
        <div class="form-group">
          <label>Long Description</label>
          <textarea name="description_long"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Headquarters</label>
            <input type="text" name="headquarters">
          </div>
          <div class="form-group">
            <label>Website</label>
            <input type="url" name="website">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Job Type</label>
            <select name="jobtype">
              <option value="">Select...</option>
              <option value="full-time">Full-time</option>
              <option value="part-time">Part-time</option>
            </select>
          </div>
          <div class="form-group">
            <label>Experience Level</label>
            <select name="experience">
              <option value="">Select...</option>
              <option value="internship">Internship</option>
              <option value="junior">Junior / Entry</option>
              <option value="mid">Mid Level</option>
              <option value="senior">Senior</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add Job Posting
        </button>
      </form>
    </div>

    <div class="items-list">
      <h2 style="padding:1.5rem; margin:0; border-bottom:2px solid rgba(0,0,0,.1);">Current Job Postings</h2>
      <div id="jobsList">
        <div class="empty-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Startups Tab -->
  <div id="startups" class="tab-content">
    <div class="admin-form">
      <h2>Add New Startup</h2>
      <form id="addStartupForm">
        <div class="form-row">
          <div class="form-group">
            <label>Startup Name *</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>Industry</label>
            <input type="text" name="industry">
          </div>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <textarea name="description" required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Website</label>
            <input type="text" name="website" placeholder="https://example.com">
          </div>
          <div class="form-group">
            <label>Logo URL</label>
            <input type="text" name="logoUrl" placeholder="https://example.com/logo.png">
          </div>
        </div>
        <div class="form-group">
          <label>Detail Page URL</label>
          <input type="text" name="detailPageUrl" placeholder="e.g., Online_Startup_Companies/startup-name.html">
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add Startup
        </button>
      </form>
    </div>

    <div class="items-list">
      <h2 style="padding:1.5rem; margin:0; border-bottom:2px solid rgba(0,0,0,.1);">Current Startups</h2>
      <div id="startupsList">
        <div class="empty-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- News Tab -->
  <div id="news" class="tab-content">
    <div class="admin-form">
      <h2>Add New News</h2>
      <form id="addNewsForm">
        <div class="form-group">
          <label>Title *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <textarea name="description" required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Image URL *</label>
            <input type="url" name="imageUrl" required>
          </div>
          <div class="form-group">
            <label>Date *</label>
            <input type="text" name="date" placeholder="e.g., Feb 26, 2025" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add News
        </button>
      </form>
    </div>

    <div class="items-list">
      <h2 style="padding:1.5rem; margin:0; border-bottom:2px solid rgba(0,0,0,.1);">Current News</h2>
      <div id="newsList">
        <div class="empty-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Legacy Tab -->
  <div id="legacy" class="tab-content">
    <div class="admin-form">
      <h2>Add Legacy Member</h2>
      <form id="addLegacyForm">
        <div class="form-row">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>Position *</label>
            <input type="text" name="position" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Year *</label>
            <input type="text" name="year" placeholder="e.g., 2024" required>
          </div>
          <div class="form-group">
            <label>Category *</label>
            <select name="category" id="legacyCategory" required>
              <option value="">Select...</option>
              <option value="board">Board Committee</option>
              <option value="vice-chair">Vice Chair</option>
              <option value="committee">Committee Member</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="subcategoryRow" style="display: none;">
          <div class="form-group">
            <label>Committee Subcategory</label>
            <select name="subcategory" id="legacySubcategory">
              <option value="">Select Committee...</option>
              <option value="it">IT Committee</option>
              <option value="marketing">Marketing Committee</option>
              <option value="entrepreneurship">Entrepreneurship & Business Committee</option>
              <option value="academic">Academic Support Committee</option>
              <option value="event">Event Planning Committee</option>
              <option value="hr">HR Committee</option>
              <option value="law">Law Committee</option>
              <option value="int-relations">International Relations Committee</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>LinkedIn URL</label>
            <input type="url" name="linkedin" placeholder="https://linkedin.com/in/...">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add Legacy Member
        </button>
      </form>
    </div>

    <div class="items-list">
      <h2 style="padding:1.5rem; margin:0; border-bottom:2px solid rgba(0,0,0,.1);">Current Legacy Members</h2>
      <div id="legacyList">
        <div class="empty-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Tab -->
  <div id="users" class="tab-content">
    <div class="admin-form">
      <h2>Add New Member</h2>
      <form id="addUserForm">
        <div class="form-row">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" name="name" id="userName" required>
          </div>
          <div class="form-group">
            <label>Surname *</label>
            <input type="text" name="surname" id="userSurname" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Username *</label>
            <input type="text" name="username" id="userUsername" required readonly>
            <small style="color:var(--muted); font-size:.85rem;">Auto-generated from name.surname</small>
          </div>
          <div class="form-group">
            <label>Password *</label>
            <input type="password" name="password" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email">
          </div>
          <div class="form-group">
            <label>Gender</label>
            <select name="gender">
              <option value="">Select...</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
              <option value="Prefer not to say">Prefer not to say</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Major</label>
            <input type="text" name="major">
          </div>
          <div class="form-group">
            <label>University</label>
            <input type="text" name="uni">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Year of Birth</label>
            <input type="text" name="yob" placeholder="e.g., 2000">
          </div>
          <div class="form-group">
            <label>CV Link</label>
            <input type="url" name="cvLink" placeholder="https://...">
          </div>
        </div>
        <div class="form-group">
          <label class="admin-checkbox-label" style="position: relative; display: inline-block; cursor: not-allowed;">
            <input type="checkbox" name="isAdmin" value="true" id="isAdminCheckbox" disabled style="width:auto; margin-right:.5rem; cursor: not-allowed; opacity: 0.6;">
            Admin User
            <span class="admin-checkbox-tooltip">You don't have permission to edit</span>
          </label>
          <small style="display:block; color:var(--muted); font-size:.85rem; margin-top:.25rem;">
            Check this box to make this user an admin
          </small>
        </div>
        <div class="form-group">
          <label>Admin Permissions</label>
          <div style="display:flex; flex-wrap:wrap; gap:.75rem;">
            <label class="admin-checkbox-label"><input type="checkbox" name="canTalentPool" value="true" disabled style="width:auto; margin-right:.35rem; cursor: not-allowed; opacity: 0.6;"> Talent Pool<span class="admin-checkbox-tooltip">You don't have permission to edit</span></label>
            <label class="admin-checkbox-label"><input type="checkbox" name="canStartups" value="true" disabled style="width:auto; margin-right:.35rem; cursor: not-allowed; opacity: 0.6;"> Startup Hub<span class="admin-checkbox-tooltip">You don't have permission to edit</span></label>
            <label class="admin-checkbox-label"><input type="checkbox" name="canNews" value="true" disabled style="width:auto; margin-right:.35rem; cursor: not-allowed; opacity: 0.6;"> News<span class="admin-checkbox-tooltip">You don't have permission to edit</span></label>
            <label class="admin-checkbox-label"><input type="checkbox" name="canLegacy" value="true" disabled style="width:auto; margin-right:.35rem; cursor: not-allowed; opacity: 0.6;"> Legacy<span class="admin-checkbox-tooltip">You don't have permission to edit</span></label>
            <label class="admin-checkbox-label"><input type="checkbox" name="canUsers" value="true" disabled style="width:auto; margin-right:.35rem; cursor: not-allowed; opacity: 0.6;"> Add Member<span class="admin-checkbox-tooltip">You don't have permission to edit</span></label>
            <label class="admin-checkbox-label"><input type="checkbox" name="canLogs" value="true" disabled style="width:auto; margin-right:.35rem; cursor: not-allowed; opacity: 0.6;"> Logs<span class="admin-checkbox-tooltip">You don't have permission to edit</span></label>
          </div>
          <small style="display:block; color:var(--muted); font-size:.85rem; margin-top:.25rem;">
            Permissions default to off for new members.
          </small>
        </div>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-user-plus"></i> Add Member
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Applicants Modal -->
<div id="applicantsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalCompanyName">Applicants</h2>
      <button class="modal-close">&times;</button>
    </div>
    <div id="applicantsContent">
      <div class="empty-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading...</p>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://anka-vkrl.onrender.com';

// Helper function to get subcategory display name
function getSubcategoryName(subcategory) {
  const names = {
    'it': 'IT Committee',
    'marketing': 'Marketing Committee',
    'entrepreneurship': 'Entrepreneurship & Business Committee',
    'academic': 'Academic Support Committee',
    'event': 'Event Planning Committee',
    'hr': 'HR Committee',
    'law': 'Law Committee',
    'int-relations': 'International Relations Committee'
  };
  return names[subcategory] || subcategory;
}
const username = sessionStorage.getItem('username');
const isAdminValue = sessionStorage.getItem('isAdmin');
const isAdmin = isAdminValue === 'true';
const isMasterValue = sessionStorage.getItem('isMaster');
const isMaster = isMasterValue === 'true'; // Boolean: true or false
const permissions = {
  canTalentPool: sessionStorage.getItem('canTalentPool') === 'true',
  canStartups: sessionStorage.getItem('canStartups') === 'true',
  canNews: sessionStorage.getItem('canNews') === 'true',
  canLegacy: sessionStorage.getItem('canLegacy') === 'true',
  canUsers: sessionStorage.getItem('canUsers') === 'true',
  canLogs: sessionStorage.getItem('canLogs') === 'true'
};

if (isMaster === true) {
  permissions.canTalentPool = true;
  permissions.canStartups = true;
  permissions.canNews = true;
  permissions.canLegacy = true;
  permissions.canUsers = true;
  permissions.canLogs = true;
}

// ==================== ADMIN LOGGING SYSTEM ====================
// Generate unique session ID
const sessionId = `admin_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

// Keypress logging (debounced to avoid spam)
let keypressBuffer = [];
let keypressTimeout = null;
const KEYPRESS_DEBOUNCE_MS = 5000; // Log keypresses every 5 seconds

// Log function
async function logAdminAction(actionType, details = {}, keyPressed = null, keyCode = null) {
  if (!username) return;
  
  try {
    const logData = {
      adminUsername: username,
      actionType,
      details,
      keyPressed,
      keyCode,
      sessionId,
      timestamp: new Date().toISOString()
    };
    
    await fetch(`${API_BASE}/api/admin/logs`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(logData)
    });
  } catch (err) {
    console.error('Failed to log admin action:', err);
    // Silently fail - don't interrupt user experience
  }
}

// Log keypress (debounced)
function logKeypress(key, code) {
  keypressBuffer.push({ key, code, timestamp: Date.now() });
  
  // Clear existing timeout
  if (keypressTimeout) {
    clearTimeout(keypressTimeout);
  }
  
  // Set new timeout to batch log keypresses
  keypressTimeout = setTimeout(() => {
    if (keypressBuffer.length > 0) {
      logAdminAction('keypress', {
        keypressCount: keypressBuffer.length,
        keys: keypressBuffer.map(k => ({ key: k.key, code: k.code, timestamp: k.timestamp }))
      });
      keypressBuffer = [];
    }
  }, KEYPRESS_DEBOUNCE_MS);
}

// Log page enter
logAdminAction('page_enter', {
  url: window.location.href,
  userAgent: navigator.userAgent,
  screenResolution: `${window.screen.width}x${window.screen.height}`
});

// Log page exit
window.addEventListener('beforeunload', () => {
  // Use sendBeacon for reliable logging on page unload
  const logData = JSON.stringify({
    adminUsername: username,
    actionType: 'page_exit',
    details: {
      url: window.location.href,
      timeSpent: Date.now() - parseInt(sessionId.split('_')[1])
    },
    sessionId,
    timestamp: new Date().toISOString()
  });
  
  navigator.sendBeacon(`${API_BASE}/api/admin/logs`, logData);
});

// Also log on visibility change (tab switch, minimize, etc.)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    logAdminAction('page_exit', {
      reason: 'visibility_change',
      url: window.location.href
    });
  } else {
    logAdminAction('page_enter', {
      reason: 'visibility_change',
      url: window.location.href
    });
  }
});

// Log all keypresses
document.addEventListener('keydown', (e) => {
  // Don't log special keys that are used for navigation
  if (['Tab', 'Shift', 'Control', 'Alt', 'Meta', 'Escape'].includes(e.key)) {
    return;
  }
  
  logKeypress(e.key, e.keyCode || e.code);
});

// ==================== END ADMIN LOGGING SYSTEM ====================

// Debug logs
console.log('Admin check - username:', username);
console.log('Admin check - isAdmin from storage:', isAdminValue, 'Type:', typeof isAdminValue);
console.log('Admin check - isAdmin boolean:', isAdmin);

// Check admin status
if (!isAdmin) {
  console.error('Admin access denied. isAdmin value:', isAdminValue);
  alert('Admin access required. Redirecting to login...');
  window.location.href = 'login.html';
}

// Add Logs tab if user is master admin and has logs permission
if (isMaster === true && permissions.canLogs === true) {
  // Add Logs tab button
  const tabContainer = document.querySelector('.admin-tabs');
  if (tabContainer) {
    const logsTabBtn = document.createElement('button');
    logsTabBtn.className = 'tab-btn';
    logsTabBtn.setAttribute('data-tab', 'logs');
    logsTabBtn.innerHTML = '<i class="fas fa-list-alt"></i> Logs';
    tabContainer.appendChild(logsTabBtn);
    
    // Logs tab button will use the general tab switching listener below
    // No need for separate event listener to avoid duplicate logging
  }
  
  // Add Logs tab content (after users tab)
  const usersTab = document.getElementById('users');
  if (usersTab && usersTab.parentElement) {
    const tabsContainer = usersTab.parentElement;
    const logsTabContent = document.createElement('div');
    logsTabContent.id = 'logs';
    logsTabContent.className = 'tab-content';
    logsTabContent.innerHTML = `
      <div class="admin-form">
        <h2>Admin Activity Logs</h2>
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
          <select id="logFilterType" class="form-group select" style="min-width: 200px; padding: 0.75rem 1.25rem; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); font-size: 0.95rem; font-family: inherit; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23718096\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 1.25rem center; background-size: 1.25rem; padding-right: 3.5rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
            <option value="">All Actions</option>
            <option value="page_enter">Page Enter</option>
            <option value="page_exit">Page Exit</option>
            <option value="tab_switch">Tab Switch</option>
            <option value="add_job">Add Job</option>
            <option value="delete_job">Delete Job</option>
            <option value="add_startup">Add Startup</option>
            <option value="delete_startup">Delete Startup</option>
            <option value="add_news">Add News</option>
            <option value="delete_news">Delete News</option>
            <option value="add_legacy">Add Legacy</option>
            <option value="delete_legacy">Delete Legacy</option>
            <option value="add_user">Add User</option>
            <option value="view_applicants">View Applicants</option>
            <option value="keypress">Keypress</option>
          </select>
          <input type="number" id="logLimit" value="100" min="10" max="1000" style="padding: 0.75rem 1.25rem; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); font-size: 0.95rem; width: 120px; font-family: inherit; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" placeholder="Limit">
          <button class="btn btn-primary" onclick="loadLogs()">
            <i class="fas fa-search"></i> Load Logs
          </button>
        </div>
      </div>

      <div class="items-list">
        <h2 style="padding:1.5rem; margin:0; border-bottom:2px solid rgba(0,0,0,.1);">Activity Logs</h2>
        <div id="logsList">
          <div class="empty-state">
            <i class="fas fa-list-alt"></i>
            <p>Click "Load Logs" to view activity</p>
          </div>
        </div>
      </div>
    `;
    tabsContainer.appendChild(logsTabContent);
  }
  
  console.log('✅ Logs tab added for master admin');
}

// Add Admin Access tab for master admin
if (isMaster === true) {
  const tabContainer = document.querySelector('.admin-tabs');
  if (tabContainer) {
    const accessTabBtn = document.createElement('button');
    accessTabBtn.className = 'tab-btn';
    accessTabBtn.setAttribute('data-tab', 'admin-access');
    accessTabBtn.innerHTML = '<i class="fas fa-user-shield"></i> Admin Access';
    tabContainer.appendChild(accessTabBtn);
  }

  const usersTab = document.getElementById('users');
  if (usersTab && usersTab.parentElement) {
    const tabsContainer = usersTab.parentElement;
    const accessTabContent = document.createElement('div');
    accessTabContent.id = 'admin-access';
    accessTabContent.className = 'tab-content';
    accessTabContent.innerHTML = `
      <div class="admin-form">
        <h2>Admin Access & Permissions</h2>
        <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:center;">
          <input type="text" id="adminUserSearch" placeholder="Search by name or username" style="padding: 0.75rem 1rem; border-radius: 10px; border: 2px solid var(--border); background: white; font-size: 0.95rem; min-width: 260px;">
          <button class="btn btn-primary" id="refreshAdminUsers">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
        <small style="display:block; color:var(--muted); font-size:.85rem; margin-top:.5rem;">
          Toggle admin and section access for members. Master admins have full access by default.
        </small>
      </div>
      <div class="items-list">
        <h2 style="padding:1.5rem; margin:0; border-bottom:2px solid rgba(0,0,0,.1);">Members</h2>
        <div id="adminAccessList">
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <p>Click Refresh to load users</p>
          </div>
        </div>
      </div>
    `;
    tabsContainer.appendChild(accessTabContent);
  }
}

const tabPermissions = {
  'talent-pool': permissions.canTalentPool === true,
  'startups': permissions.canStartups === true,
  'news': permissions.canNews === true,
  'legacy': permissions.canLegacy === true,
  'users': permissions.canUsers === true,
  'logs': permissions.canLogs === true && isMaster === true,
  'admin-access': isMaster === true
};

function setActiveTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

  const tabButton = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
  const tabContent = document.getElementById(tabId);
  if (tabButton) tabButton.classList.add('active');
  if (tabContent) tabContent.classList.add('active');
}

function applyTabPermissions() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    const tabId = btn.dataset.tab;
    const allowed = tabPermissions[tabId] === true;
    btn.style.display = allowed ? '' : 'none';
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
      tabContent.style.display = allowed ? '' : 'none';
    }
  });

  const firstAllowedTab = Object.keys(tabPermissions).find(tabId => tabPermissions[tabId] === true);
  if (firstAllowedTab) {
    setActiveTab(firstAllowedTab);
    return firstAllowedTab;
  }

  alert('No admin sections assigned. Please contact an administrator.');
  return null;
}

// Tab switching with event delegation (works for dynamically added tabs too)
document.querySelector('.admin-tabs')?.addEventListener('click', (e) => {
  const btn = e.target.closest('.tab-btn');
  if (!btn) return;
  
  const tabId = btn.dataset.tab;
  if (tabPermissions[tabId] !== true) return;
  console.log('Tab clicked:', tabId);
  
  // Log tab switch (only once)
  logAdminAction('tab_switch', {
    tabId,
    tabName: btn.textContent.trim()
  });
 
  setActiveTab(tabId);
  const tabElement = document.getElementById(tabId);
  console.log('Tab element found:', tabElement, 'ID:', tabId);
  
  // Reload data when switching tabs
  if (tabId === 'talent-pool') loadJobs();
  else if (tabId === 'startups') loadStartups();
  else if (tabId === 'news') loadNews();
  else if (tabId === 'legacy') loadLegacy();
  else if (tabId === 'logs' && isMaster === true) loadLogs();
  else if (tabId === 'admin-access' && isMaster === true) loadUserPermissions();
});

// Show alert
function showAlert(message, type = 'success') {
  const alertContainer = document.getElementById('alertContainer');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  alert.textContent = message;
  alertContainer.innerHTML = '';
  alertContainer.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}

// Load Jobs
async function loadJobs() {
  try {
    const res = await fetch(`${API_BASE}/api/companies`);
    const jobs = await res.json();
    const container = document.getElementById('jobsList');
    
    if (jobs.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-briefcase"></i><p>No job postings yet</p></div>';
      return;
    }
    
      container.innerHTML = jobs.map((job, index) => `
      <div class="item-card">
        <div class="item-info">
          <h3>${(job.name || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;')}</h3>
          <p><strong>Industry:</strong> ${job.industry || 'N/A'}</p>
          <p><strong>Location:</strong> ${job.headquarters || 'N/A'}</p>
          <p><strong>Job Type:</strong> ${job.jobtype || 'N/A'} | <strong>Experience:</strong> ${job.experience || 'N/A'}</p>
          <p>${job.description_short || ''}</p>
          <p><strong>Applicants:</strong> ${(job.applicants || []).length}</p>
        </div>
        <div class="item-actions">
          <button class="btn btn-small applicants-btn" data-company-name="${(job.name || '').replace(/"/g, '&quot;')}" data-action="view-applicants">
            <i class="fas fa-users"></i> View Applicants
          </button>
          <button class="btn btn-small btn-danger" data-job-id="${job._id}" data-job-name="${(job.name || '').replace(/"/g, '&quot;')}" data-action="delete-job">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `).join('');
    
    // Attach event listeners for jobs
    container.querySelectorAll('[data-action="delete-job"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-job-id');
        const name = this.getAttribute('data-job-name');
        console.log('Delete job clicked:', id, name);
        deleteJob(id, name);
      });
    });
    
    container.querySelectorAll('[data-action="view-applicants"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const companyName = btn.getAttribute('data-company-name');
        viewApplicants(companyName);
      });
    });
  } catch (err) {
    console.error('Failed to load jobs:', err);
    document.getElementById('jobsList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load jobs</p></div>';
  }
}

// Add Job
document.getElementById('addJobForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  data.username = username;
  
  // Log form submission
  logAdminAction('form_submit', {
    formType: 'add_job',
    formData: { name: data.name, industry: data.industry }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/companies`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    if (res.ok) {
      // Log successful add
      logAdminAction('add_job', {
        jobName: data.name,
        industry: data.industry,
        companyId: result.company?._id
      });
      
      showAlert('Job posting added successfully!', 'success');
      e.target.reset();
      loadJobs();
    } else {
      showAlert(result.message || 'Failed to add job posting', 'error');
    }
  } catch (err) {
    showAlert('Error adding job posting', 'error');
  }
});

// Delete Job
async function deleteJob(id, name) {
  console.log('deleteJob called with:', id, name);
  if (!id) {
    console.error('No ID provided for deletion');
    showAlert('Error: No ID provided', 'error');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete "${name}"?`)) {
    // Log cancellation
    logAdminAction('delete_job', {
      action: 'cancelled',
      jobId: id,
      jobName: name
    });
    return;
  }
  
  // Log delete attempt
  logAdminAction('delete_job', {
    action: 'attempted',
    jobId: id,
    jobName: name
  });
  
  try {
    console.log('Deleting job:', `${API_BASE}/api/admin/companies/${id}?username=${username}`);
    const res = await fetch(`${API_BASE}/api/admin/companies/${id}?username=${username}`, {
      method: 'DELETE'
    });
    
    let result;
    try {
      result = await res.json();
    } catch (jsonErr) {
      console.error('Failed to parse response:', jsonErr);
      const text = await res.text();
      console.error('Response text:', text);
      showAlert(`Server error (${res.status}): ${text || 'Unknown error'}`, 'error');
      return;
    }
    
    console.log('Delete response status:', res.status);
    console.log('Delete response:', result);
    
    if (res.ok) {
      // Log successful delete
      logAdminAction('delete_job', {
        action: 'success',
        jobId: id,
        jobName: name
      });
      
      showAlert('Job posting deleted successfully!', 'success');
      loadJobs();
    } else {
      // Log failed delete
      logAdminAction('delete_job', {
        action: 'failed',
        jobId: id,
        jobName: name,
        error: result.message || 'Unknown error'
      });
      
      const errorMsg = result.error ? `${result.message}: ${result.error}` : (result.message || `Server error ${res.status}`);
      console.error('Delete failed:', errorMsg, result);
      showAlert(errorMsg || 'Failed to delete job posting', 'error');
    }
  } catch (err) {
    console.error('Delete error:', err);
    showAlert('Error deleting job posting: ' + err.message, 'error');
  }
}

// View Applicants
async function viewApplicants(companyName) {
  // Log view applicants action
  logAdminAction('view_applicants', {
    companyName: companyName
  });
  
  const modal = document.getElementById('applicantsModal');
  const content = document.getElementById('applicantsContent');
  const title = document.getElementById('modalCompanyName');
  
  title.textContent = `Applicants for ${companyName}`;
  content.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>';
  modal.classList.add('active');
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/companies/${encodeURIComponent(companyName)}/applicants?username=${username}`);
    const data = await res.json();
    
    if (data.applicants.length === 0) {
      content.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No applicants yet</p></div>';
    } else {
      content.innerHTML = `
        <ul class="applicants-list">
          ${data.applicants.map(applicant => `
            <li class="applicant-item">
              <strong>${applicant.name} ${applicant.surname}</strong>
              <p>Username: ${applicant.username}</p>
              ${applicant.cvLink ? `<p><a href="${applicant.cvLink}" target="_blank">View CV</a></p>` : ''}
            </li>
          `).join('')}
        </ul>
      `;
    }
  } catch (err) {
    content.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load applicants</p></div>';
  }
}

// Load Startups
async function loadStartups() {
  try {
    const res = await fetch(`${API_BASE}/api/startups`);
    const startups = await res.json();
    const container = document.getElementById('startupsList');
    
    if (startups.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-rocket"></i><p>No startups yet</p></div>';
      return;
    }
    
    container.innerHTML = startups.map(startup => `
      <div class="item-card">
        <div class="item-info">
          <h3>${(startup.name || '').replace(/"/g, '&quot;')}</h3>
          <p><strong>Industry:</strong> ${startup.industry || 'N/A'}</p>
          <p>${startup.description || ''}</p>
          ${startup.website ? `<p><a href="${startup.website}" target="_blank">${startup.website}</a></p>` : ''}
        </div>
        <div class="item-actions">
          <button class="btn btn-small btn-danger" data-startup-id="${startup._id}" data-startup-name="${(startup.name || '').replace(/"/g, '&quot;')}" data-action="delete-startup">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `).join('');
    
    // Attach delete event listeners for startups
    container.querySelectorAll('[data-action="delete-startup"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-startup-id');
        const name = this.getAttribute('data-startup-name');
        console.log('Delete startup clicked:', id, name);
        deleteStartup(id, name);
      });
    });
  } catch (err) {
    console.error('Failed to load startups:', err);
    document.getElementById('startupsList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load startups</p></div>';
  }
}

// Add Startup
document.getElementById('addStartupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  data.username = username;
  
  // Log form submission
  logAdminAction('form_submit', {
    formType: 'add_startup',
    formData: { name: data.name, industry: data.industry }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/startups`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    if (res.ok) {
      // Log successful add
      logAdminAction('add_startup', {
        startupName: data.name,
        industry: data.industry,
        website: data.website,
        startupId: result.startup?._id
      });
      
      showAlert('Startup added successfully!', 'success');
      e.target.reset();
      loadStartups();
    } else {
      showAlert(result.message || 'Failed to add startup', 'error');
    }
  } catch (err) {
    showAlert('Error adding startup', 'error');
  }
});

// Delete Startup
let deletingStartupId = null; // Prevent duplicate deletions
async function deleteStartup(id, name) {
  console.log('deleteStartup called with:', id, name);
  if (!id) {
    console.error('No ID provided for deletion');
    showAlert('Error: No ID provided', 'error');
    return;
  }
  
  // Prevent duplicate deletion attempts
  if (deletingStartupId === id) {
    console.log('Delete already in progress for:', id);
    return;
  }
  
  if (!confirm(`Are you sure you want to delete "${name}"?`)) {
    // Log cancellation
    logAdminAction('delete_startup', {
      action: 'cancelled',
      startupId: id,
      startupName: name
    });
    return;
  }
  
  // Mark as deleting
  deletingStartupId = id;
  
  // Log delete attempt
  logAdminAction('delete_startup', {
    action: 'attempted',
    startupId: id,
    startupName: name
  });
  
  try {
    console.log('Deleting startup:', `${API_BASE}/api/admin/startups/${id}?username=${username}`);
    const res = await fetch(`${API_BASE}/api/admin/startups/${id}?username=${username}`, {
      method: 'DELETE'
    });
    
    let result;
    try {
      result = await res.json();
    } catch (jsonErr) {
      console.error('Failed to parse response:', jsonErr);
      const text = await res.text();
      console.error('Response text:', text);
      showAlert(`Server error (${res.status}): ${text || 'Unknown error'}`, 'error');
      return;
    }
    
    console.log('Delete response status:', res.status);
    console.log('Delete response:', result);
    
    if (res.ok) {
      // Log successful delete
      logAdminAction('delete_startup', {
        action: 'success',
        startupId: id,
        startupName: name
      });
      
      showAlert('Startup deleted successfully!', 'success');
      loadStartups();
    } else {
      // Log failed delete
      logAdminAction('delete_startup', {
        action: 'failed',
        startupId: id,
        startupName: name,
        error: result.message || 'Unknown error'
      });
      
      const errorMsg = result.error ? `${result.message}: ${result.error}` : (result.message || `Server error ${res.status}`);
      console.error('Delete failed:', errorMsg, result);
      showAlert(errorMsg || 'Failed to delete startup', 'error');
    }
  } catch (err) {
    console.error('Delete error:', err);
    showAlert('Error deleting startup: ' + err.message, 'error');
  } finally {
    // Clear deletion flag
    deletingStartupId = null;
  }
}

// Load News
async function loadNews() {
  try {
    const res = await fetch(`${API_BASE}/api/news`);
    const news = await res.json();
    const container = document.getElementById('newsList');
    
    if (news.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-newspaper"></i><p>No news yet</p></div>';
      return;
    }
    
      container.innerHTML = news.map(item => `
      <div class="item-card">
        <div class="item-info">
          <h3>${(item.title || '').replace(/"/g, '&quot;')}</h3>
          <p><strong>Date:</strong> ${item.date || ''}</p>
          <p>${(item.description || '').substring(0, 150)}${(item.description || '').length > 150 ? '...' : ''}</p>
          ${item.imageUrl ? `<p><a href="${item.imageUrl}" target="_blank">View Image</a></p>` : ''}
        </div>
        <div class="item-actions">
          <button class="btn btn-small btn-danger" data-news-id="${item._id}" data-news-title="${(item.title || '').replace(/"/g, '&quot;')}" data-action="delete-news">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `).join('');
    
    // Attach delete event listeners for news
    container.querySelectorAll('[data-action="delete-news"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-news-id');
        const title = this.getAttribute('data-news-title');
        console.log('Delete news clicked:', id, title);
        deleteNews(id, title);
      });
    });
  } catch (err) {
    console.error('Failed to load news:', err);
    document.getElementById('newsList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load news</p></div>';
  }
}

// Add News
document.getElementById('addNewsForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  data.username = username;
  
  // Log form submission
  logAdminAction('form_submit', {
    formType: 'add_news',
    formData: { title: data.title }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/news`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    if (res.ok) {
      // Log successful add
      logAdminAction('add_news', {
        newsTitle: data.title,
        date: data.date,
        newsId: result.news?._id
      });
      
      showAlert('News added successfully!', 'success');
      e.target.reset();
      loadNews();
    } else {
      showAlert(result.message || 'Failed to add news', 'error');
    }
  } catch (err) {
    showAlert('Error adding news', 'error');
  }
});

// Delete News
async function deleteNews(id, title) {
  console.log('deleteNews called with:', id, title);
  if (!id) {
    console.error('No ID provided for deletion');
    showAlert('Error: No ID provided', 'error');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete "${title}"?`)) {
    // Log cancellation
    logAdminAction('delete_news', {
      action: 'cancelled',
      newsId: id,
      newsTitle: title
    });
    return;
  }
  
  // Log delete attempt
  logAdminAction('delete_news', {
    action: 'attempted',
    newsId: id,
    newsTitle: title
  });
  
  try {
    console.log('Deleting news:', `${API_BASE}/api/admin/news/${id}?username=${username}`);
    const res = await fetch(`${API_BASE}/api/admin/news/${id}?username=${username}`, {
      method: 'DELETE'
    });
    
    let result;
    try {
      result = await res.json();
    } catch (jsonErr) {
      console.error('Failed to parse response:', jsonErr);
      const text = await res.text();
      console.error('Response text:', text);
      showAlert(`Server error (${res.status}): ${text || 'Unknown error'}`, 'error');
      return;
    }
    
    console.log('Delete response status:', res.status);
    console.log('Delete response:', result);
    
    if (res.ok) {
      // Log successful delete
      logAdminAction('delete_news', {
        action: 'success',
        newsId: id,
        newsTitle: title
      });
      
      showAlert('News deleted successfully!', 'success');
      loadNews();
    } else {
      // Log failed delete
      logAdminAction('delete_news', {
        action: 'failed',
        newsId: id,
        newsTitle: title,
        error: result.message || 'Unknown error'
      });
      
      const errorMsg = result.error ? `${result.message}: ${result.error}` : (result.message || `Server error ${res.status}`);
      console.error('Delete failed:', errorMsg, result);
      showAlert(errorMsg || 'Failed to delete news', 'error');
    }
  } catch (err) {
    console.error('Delete error:', err);
    showAlert('Error deleting news: ' + err.message, 'error');
  }
}

// Load Legacy Members
async function loadLegacy() {
  const container = document.getElementById('legacyList');
  if (!container) return;
  
  try {
    const res = await fetch(`${API_BASE}/api/legacy`);
    if (!res.ok) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load legacy members</p></div>';
      return;
    }
    
    const legacy = await res.json();
    if (!Array.isArray(legacy) || legacy.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No legacy members yet</p></div>';
      return;
    }
    
    container.innerHTML = legacy.map(item => `
      <div class="item-card">
        <div class="item-info">
          <h3>${(item.name || '').replace(/"/g, '&quot;')}</h3>
          <p><strong>Position:</strong> ${item.position || ''}</p>
          <p><strong>Year:</strong> ${item.year || ''}</p>
          <p><strong>Category:</strong> ${item.category === 'board' ? 'Board Committee' : item.category === 'vice-chair' ? 'Vice Chair' : 'Committee Member'}</p>
          ${item.subcategory ? `<p><strong>Committee:</strong> ${getSubcategoryName(item.subcategory)}</p>` : ''}
          ${item.linkedin ? `<p><a href="${item.linkedin}" target="_blank">LinkedIn</a></p>` : ''}
        </div>
        <div class="item-actions">
          <button class="btn btn-small btn-danger" data-legacy-id="${item._id}" data-legacy-name="${(item.name || '').replace(/"/g, '&quot;')}" data-action="delete-legacy">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `).join('');
    
    // Attach delete event listeners for legacy
    container.querySelectorAll('[data-action="delete-legacy"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-legacy-id');
        const name = this.getAttribute('data-legacy-name');
        deleteLegacy(id, name);
      });
    });
  } catch (err) {
    console.error('Failed to load legacy members:', err);
    container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load legacy members</p></div>';
  }
}

// Show/hide subcategory field based on category selection
document.getElementById('legacyCategory')?.addEventListener('change', function() {
  const subcategoryRow = document.getElementById('subcategoryRow');
  const subcategorySelect = document.getElementById('legacySubcategory');
  if (this.value === 'committee') {
    subcategoryRow.style.display = 'flex';
    subcategorySelect.required = true;
  } else {
    subcategoryRow.style.display = 'none';
    subcategorySelect.required = false;
    subcategorySelect.value = '';
  }
});

// Add Legacy Member
document.getElementById('addLegacyForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  data.username = username;
  
  // Only include subcategory if category is committee
  if (data.category !== 'committee') {
    delete data.subcategory;
  }
  
  // Log form submission
  logAdminAction('form_submit', {
    formType: 'add_legacy',
    formData: { name: data.name, position: data.position, category: data.category }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/legacy`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    if (res.ok) {
      // Log successful add
      logAdminAction('add_legacy', {
        legacyName: data.name,
        position: data.position,
        year: data.year,
        category: data.category,
        subcategory: data.subcategory,
        legacyId: result.legacy?._id
      });
      
      showAlert('Legacy member added successfully!', 'success');
      e.target.reset();
      document.getElementById('subcategoryRow').style.display = 'none';
      loadLegacy();
    } else {
      showAlert(result.message || 'Failed to add legacy member', 'error');
    }
  } catch (err) {
    showAlert('Error adding legacy member', 'error');
  }
});

// Delete Legacy Member
async function deleteLegacy(id, name) {
  if (!id) {
    showAlert('Error: No ID provided', 'error');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete "${name}"?`)) {
    // Log cancellation
    logAdminAction('delete_legacy', {
      action: 'cancelled',
      legacyId: id,
      legacyName: name
    });
    return;
  }
  
  // Log delete attempt
  logAdminAction('delete_legacy', {
    action: 'attempted',
    legacyId: id,
    legacyName: name
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/legacy/${id}?username=${username}`, {
      method: 'DELETE'
    });
    
    let result;
    try {
      result = await res.json();
    } catch (jsonErr) {
      const text = await res.text();
      showAlert(`Server error (${res.status}): ${text || 'Unknown error'}`, 'error');
      return;
    }
    
    if (res.ok) {
      // Log successful delete
      logAdminAction('delete_legacy', {
        action: 'success',
        legacyId: id,
        legacyName: name
      });
      
      showAlert('Legacy member deleted successfully!', 'success');
      loadLegacy();
    } else {
      // Log failed delete
      logAdminAction('delete_legacy', {
        action: 'failed',
        legacyId: id,
        legacyName: name,
        error: result.message || 'Unknown error'
      });
      
      const errorMsg = result.error ? `${result.message}: ${result.error}` : (result.message || `Server error ${res.status}`);
      showAlert(errorMsg || 'Failed to delete legacy member', 'error');
    }
  } catch (err) {
    console.error('Delete error:', err);
    showAlert('Error deleting legacy member: ' + err.message, 'error');
  }
}

// Add User
document.getElementById('addUserForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {};
  const permissionKeys = new Set([
    'canTalentPool',
    'canStartups',
    'canNews',
    'canLegacy',
    'canUsers',
    'canLogs'
  ]);
  
  // Get all form values
  for (const [key, value] of formData.entries()) {
    if (key === 'isAdmin' || permissionKeys.has(key)) {
      data[key] = value === 'true' ? true : undefined;
    } else if (value.trim() !== '') {
      data[key] = value.trim();
    }
  }
  
  // Add admin username for authentication (this is the admin's username, not the new user's)
  data.adminUsername = username;
  
  // The new user's username is in data.username (from the form)
  console.log('Adding user with data:', { ...data, password: '***' });
  
  // Log form submission
  logAdminAction('form_submit', {
    formType: 'add_user',
    formData: { 
      name: data.name, 
      surname: data.surname, 
      username: data.username,
      isAdmin: data.isAdmin === true,
      permissions: Array.from(permissionKeys).filter(key => data[key] === true)
    }
  });
  
  try {
    const res = await fetch(`${API_BASE}/api/admin/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    let result;
    try {
      result = await res.json();
    } catch (jsonErr) {
      const text = await res.text();
      showAlert(`Server error (${res.status}): ${text || 'Unknown error'}`, 'error');
      return;
    }
    
    if (res.ok) {
      // Log successful add
      logAdminAction('add_user', {
        newUsername: data.username,
        newUserName: data.name,
        newUserSurname: data.surname,
        isAdmin: data.isAdmin === true,
        userId: result.user?.username
      });
      
      // Log admin grant if isAdmin is true, including all granted permissions
      if (data.isAdmin === true) {
        const grantedPermissions = [];
        if (data.isAdmin === true) grantedPermissions.push('isAdmin');
        if (data.canTalentPool === true) grantedPermissions.push('canTalentPool');
        if (data.canStartups === true) grantedPermissions.push('canStartups');
        if (data.canNews === true) grantedPermissions.push('canNews');
        if (data.canLegacy === true) grantedPermissions.push('canLegacy');
        if (data.canUsers === true) grantedPermissions.push('canUsers');
        if (data.canLogs === true) grantedPermissions.push('canLogs');
        
        logAdminAction('grant_admin', {
          targetUsername: data.username,
          targetName: `${data.name} ${data.surname}`.trim(),
          method: 'add_user',
          newUser: true,
          grantedPermissions: grantedPermissions,
          permissionsCount: grantedPermissions.length
        });
      }
      
      showAlert('Member added successfully!', 'success');
      e.target.reset();
      const usernameInput = document.getElementById('userUsername');
      if (usernameInput) usernameInput.value = '';
    } else {
      const errorMsg = result.error ? `${result.message}: ${result.error}` : (result.message || `Server error ${res.status}`);
      showAlert(errorMsg || 'Failed to add member', 'error');
    }
  } catch (err) {
    console.error('Error adding user:', err);
    showAlert('Error adding member: ' + err.message, 'error');
  }
});

// Auto-generate username from name.surname with availability check
let usernameCheckTimeout;
document.getElementById('userName')?.addEventListener('input', updateUsername);
document.getElementById('userSurname')?.addEventListener('input', updateUsername);

async function updateUsername() {
  const name = document.getElementById('userName')?.value.trim() || '';
  const surname = document.getElementById('userSurname')?.value.trim() || '';
  const usernameInput = document.getElementById('userUsername');
  
  if (!usernameInput || !name || !surname) {
    if (usernameInput) usernameInput.value = '';
    return;
  }
  
  // Clear previous timeout
  clearTimeout(usernameCheckTimeout);
  
  // Generate base username
  const baseUsername = `${name}.${surname}`.toLowerCase()
    .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
    .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
    .replace(/[^a-z0-9.]/g, '');
  
  // Show base username immediately
  usernameInput.value = baseUsername;
  usernameInput.classList.remove('username-available', 'username-taken');
  usernameInput.style.color = '#666';
  
  // Debounce: Wait 500ms after user stops typing before checking availability
  usernameCheckTimeout = setTimeout(async () => {
    try {
      const res = await fetch(`${API_BASE}/api/admin/users/check-username?baseUsername=${encodeURIComponent(baseUsername)}`);
      const result = await res.json();
      
      if (res.ok && result.username) {
        usernameInput.value = result.username;
        
        // Change color and class based on availability
        usernameInput.classList.remove('username-available', 'username-taken');
        if (result.available) {
          usernameInput.classList.add('username-available');
          usernameInput.style.color = '#22c55e'; // Green for available
        } else {
          usernameInput.classList.add('username-taken');
          usernameInput.style.color = '#f59e0b'; // Orange for auto-incremented
        }
      } else {
        usernameInput.classList.remove('username-available', 'username-taken');
        usernameInput.style.color = '#666';
      }
    } catch (err) {
      console.error('Error checking username availability:', err);
      usernameInput.classList.remove('username-available', 'username-taken');
      usernameInput.style.color = '#666';
    }
  }, 500);
}


// Modal close
document.querySelector('.modal-close').addEventListener('click', () => {
  document.getElementById('applicantsModal').classList.remove('active');
});

document.getElementById('applicantsModal').addEventListener('click', (e) => {
  if (e.target.id === 'applicantsModal') {
    document.getElementById('applicantsModal').classList.remove('active');
  }
});

// Load Logs (Master Admin Only)
async function loadLogs() {
  // isMaster is boolean: true or false
  if (isMaster !== true) {
    console.error('Master admin access required to view logs. isMaster:', isMaster, 'Type:', typeof isMaster);
    return;
  }
  
  const container = document.getElementById('logsList');
  if (!container) return;
  
  const filterType = document.getElementById('logFilterType')?.value || '';
  const limit = document.getElementById('logLimit')?.value || 100;
  
  container.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading logs...</p></div>';
  
  try {
    let url = `${API_BASE}/api/admin/logs?username=${username}&limit=${limit}`;
    if (filterType) {
      url += `&actionType=${filterType}`;
    }
    
    const res = await fetch(url);
    
    if (!res.ok) {
      const errorData = await res.json();
      container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error: ${errorData.message || 'Failed to load logs'}</p></div>`;
      return;
    }
    
    const data = await res.json();
    
    if (!data.logs || data.logs.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No logs found</p></div>';
      return;
    }
    
    // Format timestamp helper
    const formatTime = (date) => {
      return new Date(date).toLocaleString('tr-TR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    };
    
    // Format action type
    const formatActionType = (action) => {
      return action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    };
    
    container.innerHTML = `
      <div style="padding: 0.75rem 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
        <strong>Total Logs:</strong> ${data.count}
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
          <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid var(--border);">
              <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text);">Time</th>
              <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text);">Admin</th>
              <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text);">Action</th>
              <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text);">Details</th>
              <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text);">IP</th>
            </tr>
          </thead>
          <tbody>
            ${data.logs.map((log, index) => {
              const timestamp = formatTime(log.timestamp);
              const actionType = formatActionType(log.actionType);
              
              // Action type colors
              const actionColors = {
                'page_enter': { bg: '#d1fae5', color: '#065f46' }, // Green
                'page_exit': { bg: '#fee2e2', color: '#991b1b' }, // Red
                'tab_switch': { bg: '#dbeafe', color: '#1e40af' }, // Blue
                'add_job': { bg: '#d1fae5', color: '#065f46' }, // Green
                'delete_job': { bg: '#fee2e2', color: '#991b1b' }, // Red
                'add_startup': { bg: '#d1fae5', color: '#065f46' }, // Green
                'delete_startup': { bg: '#fee2e2', color: '#991b1b' }, // Red
                'add_news': { bg: '#d1fae5', color: '#065f46' }, // Green
                'delete_news': { bg: '#fee2e2', color: '#991b1b' }, // Red
                'add_legacy': { bg: '#d1fae5', color: '#065f46' }, // Green
                'delete_legacy': { bg: '#fee2e2', color: '#991b1b' }, // Red
                'add_user': { bg: '#d1fae5', color: '#065f46' }, // Green
                'grant_admin': { bg: '#fed7aa', color: '#9a3412' }, // Orange - Critical action
                'view_applicants': { bg: '#dbeafe', color: '#1e40af' }, // Blue
                'keypress': { bg: '#f3f4f6', color: '#374151' }, // Gray
                'form_submit': { bg: '#e9d5ff', color: '#6b21a8' }, // Purple
                'form_reset': { bg: '#fef3c7', color: '#92400e' } // Yellow
              };
              
              const actionColor = actionColors[log.actionType] || { bg: '#e5e7eb', color: '#374151' };
              
              // Get details summary
              let detailsText = '-';
              if (log.details && Object.keys(log.details).length > 0) {
                if (log.details.jobName) detailsText = log.details.jobName;
                else if (log.details.startupName) detailsText = log.details.startupName;
                else if (log.details.newsTitle) detailsText = log.details.newsTitle;
                else if (log.details.legacyName) detailsText = log.details.legacyName;
                else if (log.details.newUsername) detailsText = `User: ${log.details.newUsername}`;
                else if (log.details.targetUsername) {
                  // Show permissions for grant_admin
                  let permText = `Admin granted to: ${log.details.targetUsername}`;
                  if (log.details.grantedPermissions && log.details.grantedPermissions.length > 0) {
                    permText += ` (${log.details.grantedPermissions.join(', ')})`;
                  }
                  if (log.details.revokedPermissions && log.details.revokedPermissions.length > 0) {
                    permText += ` [Revoked: ${log.details.revokedPermissions.join(', ')}]`;
                  }
                  detailsText = permText;
                }
                else if (log.details.companyName) detailsText = log.details.companyName;
                else if (log.details.tabId) detailsText = log.details.tabId;
                else if (log.details.keypressCount) detailsText = `${log.details.keypressCount} keys`;
                else detailsText = 'View details';
              }
              
              const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
              
              return `
                <tr style="background: ${rowBg}; border-bottom: 1px solid var(--border); transition: background 0.2s;">
                  <td style="padding: 0.75rem 1rem; font-size: 0.85rem; color: var(--muted); white-space: nowrap;">${timestamp}</td>
                  <td style="padding: 0.75rem 1rem; font-size: 0.85rem; color: var(--text);">${log.adminUsername}</td>
                  <td style="padding: 0.75rem 1rem; font-size: 0.85rem;">
                    <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; background: ${actionColor.bg}; color: ${actionColor.color}; font-weight: 500; font-size: 0.8rem;">
                      ${actionType}
                    </span>
                  </td>
                  <td style="padding: 0.75rem 1rem; font-size: 0.85rem; color: var(--text); max-width: 300px;">
                    ${log.details && Object.keys(log.details).length > 0 ? `
                      <details style="cursor: pointer;">
                        <summary style="color: var(--brand-2); font-size: 0.85rem; outline: none;">${detailsText}</summary>
                        <pre style="margin-top: 0.5rem; padding: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 4px; font-size: 0.75rem; overflow-x: auto; max-height: 200px; overflow-y: auto;">${JSON.stringify(log.details, null, 2)}</pre>
                      </details>
                    ` : detailsText}
                  </td>
                  <td style="padding: 0.75rem 1rem; font-size: 0.8rem; color: var(--muted); font-family: monospace;">${log.ipAddress || 'N/A'}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  } catch (err) {
    console.error('Failed to load logs:', err);
    container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load logs: ' + err.message + '</p></div>';
  }
}

// ==================== Admin Access (Master Admin) ====================
let adminUsersCache = [];

function escapeHtml(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function renderAdminAccessList() {
  const container = document.getElementById('adminAccessList');
  if (!container) return;

  const query = (document.getElementById('adminUserSearch')?.value || '').toLowerCase();
  const filtered = adminUsersCache.filter((user) => {
    const name = `${user.name || ''} ${user.surname || ''}`.trim().toLowerCase();
    const usernameValue = String(user.username || '').toLowerCase();
    return !query || name.includes(query) || usernameValue.includes(query);
  });

  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No users found</p></div>';
    return;
  }

  container.innerHTML = filtered.map((user) => {
    const fullName = `${user.name || ''} ${user.surname || ''}`.trim() || user.username || 'User';
    const isMasterUser = user.isMaster === true;
    const isAdminUser = user.isAdmin === true;
    const disabledAttr = isMasterUser ? 'disabled' : '';
    const permDisabledAttr = (!isAdminUser || isMasterUser) ? 'disabled' : '';
    const adminToggleClass = isMasterUser ? 'permission-toggle disabled' : 'permission-toggle';
    const permToggleClass = (!isAdminUser || isMasterUser) ? 'permission-toggle disabled' : 'permission-toggle';

    return `
      <div class="item-card">
        <div class="item-info">
          <h3>${escapeHtml(fullName)}</h3>
          <p><strong>Username:</strong> ${escapeHtml(user.username || '')}</p>
          ${user.email ? `<p><strong>Email:</strong> ${escapeHtml(user.email)}</p>` : ''}
          <p><strong>Master:</strong> ${isMasterUser ? 'Yes' : 'No'}</p>
        </div>
        <div class="item-actions">
          <label class="${adminToggleClass}">
            <input type="checkbox" data-field="isAdmin" ${isAdminUser ? 'checked' : ''} ${disabledAttr}>
            Admin
          </label>
          <label class="${permToggleClass}">
            <input type="checkbox" data-field="canTalentPool" ${user.canTalentPool === true ? 'checked' : ''} ${permDisabledAttr}>
            Talent Pool
          </label>
          <label class="${permToggleClass}">
            <input type="checkbox" data-field="canStartups" ${user.canStartups === true ? 'checked' : ''} ${permDisabledAttr}>
            Startups
          </label>
          <label class="${permToggleClass}">
            <input type="checkbox" data-field="canNews" ${user.canNews === true ? 'checked' : ''} ${permDisabledAttr}>
            News
          </label>
          <label class="${permToggleClass}">
            <input type="checkbox" data-field="canLegacy" ${user.canLegacy === true ? 'checked' : ''} ${permDisabledAttr}>
            Legacy
          </label>
          <label class="${permToggleClass}">
            <input type="checkbox" data-field="canUsers" ${user.canUsers === true ? 'checked' : ''} ${permDisabledAttr}>
            Users
          </label>
          <label class="${permToggleClass}">
            <input type="checkbox" data-field="canLogs" ${user.canLogs === true ? 'checked' : ''} ${permDisabledAttr}>
            Logs
          </label>
          <button class="btn btn-small btn-primary" data-action="save-permissions" data-username="${escapeHtml(user.username || '')}" ${disabledAttr}>
            <i class="fas fa-save"></i> Save
          </button>
        </div>
      </div>
    `;
  }).join('');

  bindAdminAccessEvents();
}

function bindAdminAccessEvents() {
  const container = document.getElementById('adminAccessList');
  if (!container) return;

  container.querySelectorAll('input[data-field="isAdmin"]').forEach((checkbox) => {
    checkbox.addEventListener('change', () => {
      const row = checkbox.closest('.item-card');
      if (!row) return;
      const permCheckboxes = row.querySelectorAll('input[data-field^="can"]');
      if (!checkbox.checked) {
        permCheckboxes.forEach((cb) => {
          cb.checked = false;
          cb.disabled = true;
        });
      } else {
        permCheckboxes.forEach((cb) => {
          cb.disabled = false;
        });
      }
    });
  });

  container.querySelectorAll('[data-action="save-permissions"]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const targetUsername = btn.getAttribute('data-username');
      const row = btn.closest('.item-card');
      if (!row || !targetUsername) return;

      const fields = {};
      row.querySelectorAll('input[type="checkbox"][data-field]').forEach((cb) => {
        fields[cb.getAttribute('data-field')] = cb.checked;
      });

      // Get current user state from cache to check if admin status is being granted
      const currentUser = adminUsersCache.find(u => u.username === targetUsername);
      const wasAdmin = currentUser?.isAdmin === true;
      const willBeAdmin = fields.isAdmin === true;

      if (fields.isAdmin !== true) {
        Object.keys(fields).forEach((key) => {
          if (key.startsWith('can')) {
            fields[key] = false;
          }
        });
      }

      try {
        const res = await fetch(`${API_BASE}/api/admin/users/${encodeURIComponent(targetUsername)}/permissions?username=${encodeURIComponent(username)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fields)
        });

        const result = await res.json();
        if (res.ok) {
          // Log admin grant if admin status is being granted (was false, now true)
          // Also track which permissions were granted/revoked
          if (!wasAdmin && willBeAdmin) {
            const targetName = currentUser ? `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() : targetUsername;
            
            // Calculate which permissions were granted/revoked
            const grantedPermissions = [];
            const revokedPermissions = [];
            
            const permissionFields = ['isAdmin', 'canTalentPool', 'canStartups', 'canNews', 'canLegacy', 'canUsers', 'canLogs'];
            permissionFields.forEach((field) => {
              const wasSet = currentUser[field] === true;
              const willBeSet = fields[field] === true;
              
              if (!wasSet && willBeSet) {
                grantedPermissions.push(field);
              } else if (wasSet && !willBeSet) {
                revokedPermissions.push(field);
              }
            });
            
            logAdminAction('grant_admin', {
              targetUsername: targetUsername,
              targetName: targetName || targetUsername,
              method: 'update_permissions',
              newUser: false,
              grantedPermissions: grantedPermissions,
              revokedPermissions: revokedPermissions,
              permissionsCount: grantedPermissions.length
            });
          }
          
          showAlert('Permissions updated successfully!', 'success');
          await loadUserPermissions();
        } else {
          showAlert(result.message || 'Failed to update permissions', 'error');
        }
      } catch (err) {
        showAlert('Error updating permissions', 'error');
      }
    });
  });
}

async function loadUserPermissions() {
  const container = document.getElementById('adminAccessList');
  if (!container) return;

  container.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading users...</p></div>';

  try {
    const res = await fetch(`${API_BASE}/api/admin/users/list?username=${encodeURIComponent(username)}`);
    const data = await res.json();
    if (!res.ok) {
      container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>${data.message || 'Failed to load users'}</p></div>`;
      return;
    }

    adminUsersCache = Array.isArray(data.users) ? data.users : [];
    renderAdminAccessList();
  } catch (err) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load users</p></div>';
  }
}

document.getElementById('refreshAdminUsers')?.addEventListener('click', (e) => {
  e.preventDefault();
  loadUserPermissions();
});

document.getElementById('adminUserSearch')?.addEventListener('input', renderAdminAccessList);

// Debug: Check all tab contents on load
console.log('Available tab contents on load:', Array.from(document.querySelectorAll('.tab-content')).map(el => ({ id: el.id, classes: el.className })));

// Enhanced dropdown styling with JavaScript
document.addEventListener('DOMContentLoaded', () => {
  // Add hover and focus effects to all selects
  const styleSelects = () => {
    document.querySelectorAll('select').forEach(select => {
      // Remove class if exists to avoid duplicates
      select.classList.remove('enhanced-select');
      select.classList.add('enhanced-select');
      
      // Add hover effect
      select.addEventListener('mouseenter', function() {
        if (!this.matches(':focus')) {
          this.style.borderColor = 'var(--brand-1)';
          this.style.backgroundColor = '#fff';
          this.style.boxShadow = '0 2px 8px rgba(226,135,74,.08)';
          this.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23e2874a\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E')`;
        }
      });
      
      select.addEventListener('mouseleave', function() {
        if (!this.matches(':focus')) {
          this.style.borderColor = 'var(--border)';
          this.style.backgroundColor = 'var(--card-bg)';
          this.style.boxShadow = 'none';
          this.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23718096\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E')`;
        }
      });
      
      // Add focus effect
      select.addEventListener('focus', function() {
        this.style.borderColor = 'var(--brand-2)';
        this.style.boxShadow = '0 0 0 4px rgba(226,135,74,.12), var(--shadow-md)';
        this.style.transform = 'translateY(-1px)';
        this.style.backgroundColor = '#fff';
        this.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23e2874a\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E')`;
      });
      
      select.addEventListener('blur', function() {
        this.style.borderColor = 'var(--border)';
        this.style.boxShadow = 'none';
        this.style.transform = 'translateY(0)';
        this.style.backgroundColor = 'var(--card-bg)';
        this.style.backgroundImage = `url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'16\' height=\'16\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23718096\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3E%3Cpolyline points=\'6 9 12 15 18 9\'%3E%3C/polyline%3E%3C/svg%3E')`;
      });
    });
  };
  
  // Run on load
  styleSelects();
  
  // Re-run when new content is added (e.g., logs tab)
  const observer = new MutationObserver(() => {
    styleSelects();
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
});
console.log('Users tab element:', document.getElementById('users'));
console.log('isMaster:', isMaster, 'Type:', typeof isMaster, 'Value:', isMasterValue);

// Initial load
const initialTab = applyTabPermissions();
if (initialTab === 'talent-pool') loadJobs();
else if (initialTab === 'startups') loadStartups();
else if (initialTab === 'news') loadNews();
else if (initialTab === 'legacy') loadLegacy();
else if (initialTab === 'logs' && isMaster === true) loadLogs();
else if (initialTab === 'admin-access' && isMaster === true) loadUserPermissions();
</script>
</body>
</html>

